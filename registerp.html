<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Patient Registration - DHRMS</title>
    <link rel="stylesheet" href="registerp.css">
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="header-logo">
                <span>DHRMS Kerala</span>
            </div>
            <!-- <div class="header-user-info">
                <span>Welcome, Operator_101</span>
                <a href="main1.html" class="logout-button">Logout</a>
            </div> -->
        </div>
    </header>

    <main class="form-container">
        <h1>New Worker Registration</h1>
        
        <div class="health-id-display">
            <strong>System Generated Health ID:</strong> <span id="healthIdValue">(Will be generated upon submission)</span>
        </div>

        <form action="#" method="POST" class="registration-form">
            <!-- Personal & Identification -->
            <fieldset>
                <legend>Personal & Identification Details</legend>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="input-group">
                        <label for="aadhaar">Aadhaar Number *</label>
                        <input type="text" id="aadhaar" name="aadhaar" pattern="\d{12}" title="12-digit Aadhaar number" required>
                    </div>
                    <div class="input-group">
                        <label for="dob">Date of Birth *</label>
                        <input type="date" id="dob" name="dob" required>
                    </div>
                    <div class="input-group">
                        <label for="age">Age</label>
                        <input type="text" id="age" name="age" disabled>
                    </div>
                    <div class="input-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" name="gender" required>
                            <option value="">-- Select --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="photo">Patient Photograph (optional)</label>
                        <input type="file" id="photo" name="photo" accept="image/*">
                    </div>
                    <div class="input-group">
                        <label for="guardianName">Father's / Guardian's Name</label>
                        <input type="text" id="guardianName" name="guardianName">
                    </div>
                     <div class="input-group">
                        <label for="motherTongue">Mother Tongue</label>
                        <select id="motherTongue" name="motherTongue">
                            <option value="">-- Select --</option>
                            <option value="Malayalam">Malayalam</option>
                            <option value="Bengali">Bengali</option>
                            <option value="Odia">Odia</option>
                            <option value="Hindi">Hindi</option>
                            <option value="Assamese">Assamese</option>
                            <option value="Tamil">Tamil</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <!-- Origin & Contact -->
            <fieldset>
                <legend>Origin & Contact Information</legend>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="mobile">Mobile Number *</label>
                        <input type="tel" id="mobile" name="mobile" pattern="\d{10}" title="10-digit mobile number" required>
                    </div>
                    <div class="input-group">
                        <label for="homeState">Home State *</label>
                        <select id="homeState" name="homeState" required>
                            <option value="">-- Select State --</option>
                            <option value="West Bengal">West Bengal</option>
                            <option value="Odisha">Odisha</option>
                            <option value="Assam">Assam</option>
                            <option value="Bihar">Bihar</option>
                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                            <option value="Tamil Nadu">Tamil Nadu</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="input-group full-width">
                        <label for="currentAddress">Current Address (in Kerala) *</label>
                        <textarea id="currentAddress" name="currentAddress" rows="3" required></textarea>
                    </div>
                     <div class="input-group">
                        <label for="district">District *</label>
                        <select id="district" name="district" required>
                             <option value="">-- Select District --</option>
                             <option value="Thiruvananthapuram">Thiruvananthapuram</option>
                             <option value="Kollam">Kollam</option>
                             <option value="Ernakulam">Ernakulam</option>
                             <option value="Kozhikode">Kozhikode</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="pincode">Pincode *</label>
                        <input type="text" id="pincode" name="pincode" pattern="\d{6}" required>
                    </div>
                </div>
            </fieldset>

            <!-- Health Intake -->
            <fieldset>
                <legend>Initial Health Intake</legend>
                <div class="form-grid">
                     <div class="input-group">
                        <label for="bloodGroup">Blood Group *</label>
                        <select id="bloodGroup" name="bloodGroup" required>
                            <option value="">-- Select --</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="occupation">Occupation</label>
                        <input type="text" id="occupation" name="occupation" placeholder="e.g., Construction Worker">
                    </div>
                    <div class="input-group full-width">
                        <label for="allergies">Known Allergies (if any)</label>
                        <input type="text" id="allergies" name="allergies" placeholder="e.g., Penicillin, Dust">
                    </div>
                    <div class="input-group full-width">
                        <label for="conditions-input">Pre-existing Conditions (Type a disease and press Enter)</label>
                        <div class="tag-container" id="conditions-container">
                            <input type="text" id="conditions-input" placeholder="e.g., Diabetes, Hypertension...">
                        </div>
                        <input type="hidden" name="preexisting_conditions" id="preexisting_conditions">
                    </div>
                </div>
            </fieldset>

            <div class="form-actions">
                <button type="reset" class="btn btn-secondary">Reset Form</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Register Patient</button>
            </div>
        </form>

        <div id="qrSection" style="margin-top:20px; display:none;">
            <h3>Patient QR Code</h3>
            <canvas id="qrCanvas"></canvas>
        </div>
    </main>

    <!-- Auto age + conditions tags -->
    <script>
        document.getElementById('dob').addEventListener('change', function() {
            const dob = new Date(this.value);
            if (!isNaN(dob.getTime())) {
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                document.getElementById('age').value = age >= 0 ? age : '';
            }
        });

        // Disease tags
        const tagContainer = document.getElementById('conditions-container');
        const tagInput = document.getElementById('conditions-input');
        const hiddenInput = document.getElementById('preexisting_conditions');
        let diseases = [];

        function updateTags() {
            tagContainer.querySelectorAll('.tag').forEach(tag => tag.remove());
            diseases.forEach(disease => {
                const tagElement = document.createElement('span');
                tagElement.classList.add('tag');
                tagElement.innerText = disease;
                
                const removeElement = document.createElement('span');
                removeElement.classList.add('remove-tag');
                removeElement.innerText = 'x';
                removeElement.onclick = () => {
                    removeDisease(disease);
                };
                
                tagElement.appendChild(removeElement);
                tagContainer.prepend(tagElement);
            });
            hiddenInput.value = diseases.join(',');
        }

        function removeDisease(diseaseToRemove) {
            diseases = diseases.filter(disease => disease !== diseaseToRemove);
            updateTags();
        }

        tagInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                const newDisease = tagInput.value.trim();
                if (newDisease && !diseases.includes(newDisease)) {
                    diseases.push(newDisease);
                    updateTags();
                }
                tagInput.value = '';
            }
        });
    </script>

    <!-- QR + Firebase -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCk34AKpzpuH49b0z8SpPhPjt7oIvEI3aw",
            authDomain: "fir-14dfd.firebaseapp.com",
            projectId: "fir-14dfd",
            storageBucket: "fir-14dfd.appspot.com",
            messagingSenderId: "721167685687",
            appId: "1:721167685687:web:6c1cb132a1c92224ae47b2",
            measurementId: "G-45VD5ZKLRY"
          };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const form = document.querySelector('form.registration-form');
        const submitBtn = document.getElementById('submitBtn');
        const healthIdSpan = document.getElementById('healthIdValue');

        async function generateUniqueHealthId() {
            const alphabet = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            const prefix = 'KER-';
            for (let attempt = 0; attempt < 10; attempt++) {
                let idBody = '';
                for (let i = 0; i < 8; i++) {
                    idBody += alphabet[Math.floor(Math.random() * alphabet.length)];
                }
                const candidate = prefix + idBody;
                const snapshot = await getDoc(doc(db, 'patients', candidate));
                if (!snapshot.exists()) {
                    return candidate;
                }
            }
            throw new Error('Unable to generate unique Health ID. Please try again.');
        }

        const CLOUDINARY_CLOUD = 'djp4uky6z';
        const CLOUDINARY_PRESET = 'image_retrival';

        async function uploadPhotoIfAny(healthId) {
            const fileInput = document.getElementById('photo');
            const file = fileInput && fileInput.files && fileInput.files[0];
            if (!file) {
                return null;
            }
            const okTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!okTypes.includes(file.type)) {
                alert('Please select a JPG, JPEG, PNG, or WEBP image.');
                return null;
            }
            const form = new FormData();
            form.append('file', file);
            form.append('upload_preset', CLOUDINARY_PRESET);
            form.append('folder', 'patient_photos');

            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, {
                method: 'POST',
                body: form
            });
            if (!res.ok) {
                throw new Error('Cloudinary upload failed');
            }
            const data = await res.json();
            return data && data.secure_url ? data.secure_url : null;
        }

        function collectFormData(healthId, photoUrl) {
            return {
                healthId,
                fullName: document.getElementById('fullName').value.trim(),
                aadhaar: document.getElementById('aadhaar').value.trim(),
                dob: document.getElementById('dob').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                guardianName: document.getElementById('guardianName').value.trim(),
                motherTongue: document.getElementById('motherTongue').value,
                mobile: document.getElementById('mobile').value.trim(),
                homeState: document.getElementById('homeState').value,
                currentAddress: document.getElementById('currentAddress').value.trim(),
                district: document.getElementById('district').value,
                pincode: document.getElementById('pincode').value.trim(),
                bloodGroup: document.getElementById('bloodGroup').value,
                occupation: document.getElementById('occupation').value.trim(),
                allergies: document.getElementById('allergies').value.trim(),
                preexisting_conditions: document.getElementById('preexisting_conditions').value,
                photoUrl: photoUrl || null,
                createdAt: new Date().toISOString()
            };
        }

        function renderQrCode(payload) {
            const qrSection = document.getElementById('qrSection');
            const canvas = document.getElementById('qrCanvas');
            const minimal = {
                healthId: payload.healthId,
                fullName: payload.fullName,
                dob: payload.dob,
                mobile: payload.mobile,
                bloodGroup: payload.bloodGroup
            };
            const QR = window.QRCode;
            if (!QR) {
                console.error('QRCode library not loaded');
                return;
            }
            QR.toCanvas(canvas, JSON.stringify(minimal), { width: 220 }, function(err) {
                if (!err) {
                    qrSection.style.display = 'block';
                }
            });
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';
            try {
                const healthId = await generateUniqueHealthId();
                healthIdSpan.textContent = healthId;
                const photoUrl = await uploadPhotoIfAny(healthId);
                const data = collectFormData(healthId, photoUrl);
                await setDoc(doc(db, 'patients', healthId), data);
                renderQrCode(data);
                try {
                    localStorage.setItem('lastRegisteredPatient', JSON.stringify(data));
                } catch (_) {}
                submitBtn.textContent = 'Registered';
                setTimeout(() => {
                    window.location.href = `patient_dashboard.html?healthId=${encodeURIComponent(healthId)}`;
                }, 600);
            } catch (err) {
                alert(err.message || 'Registration failed.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register Patient';
            }
        });
    </script>
</body>
</html>
